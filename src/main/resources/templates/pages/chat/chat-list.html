<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
    <title layout:fragment="title">채팅</title>
</head>

<body>
<div layout:fragment="content">
    <div class="mx-auto max-w-4xl px-6 py-10 space-y-6">

        <!-- Header -->
        <div class="flex items-end justify-between gap-6">
            <div>
                <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">채팅</h1>
                <p class="mt-1 text-sm text-gray-600">참여 중인 채팅방 목록이에요.</p>
            </div>

            <div class="flex items-center gap-4">
                <!-- Toggle -->
                <div class="inline-flex items-center rounded-2xl border border-gray-200 bg-white p-1 shadow-sm">
                    <button id="tabAuction"
                            type="button"
                            class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold transition">
                        경매
                    </button>
                    <button id="tabNoti"
                            type="button"
                            class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold transition">
                        알림채팅
                        <span id="notiBadge"
                              class="hidden inline-flex h-6 min-w-[24px] items-center justify-center rounded-full bg-red-500 px-2 text-xs font-extrabold text-white">
                            0
                        </span>
                    </button>
                </div>

                <!-- Meta (절대 비우지 말고 탭 기준으로 업데이트) -->
                <div id="meta" class="text-sm text-gray-600 whitespace-nowrap"></div>
            </div>
        </div>

        <!-- AUCTION CARD -->
        <section id="auctionCard" class="rounded-2xl border border-gray-200 bg-white overflow-hidden shadow-sm">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div class="text-sm font-semibold text-gray-900">경매 채팅</div>
                <div class="text-xs text-gray-500">최근 메시지 기준</div>
            </div>
            <div id="auctionRooms" class="divide-y divide-gray-100">
                <div class="px-5 py-8 flex items-center gap-3 text-sm text-gray-500">
                    <span class="inline-block h-4 w-4 rounded-full border-2 border-gray-300 border-t-transparent animate-spin"></span>
                    불러오는 중...
                </div>
            </div>
        </section>

        <!-- NOTIFICATION CARD -->
        <section id="notiCard" class="hidden rounded-2xl border border-gray-200 bg-white overflow-hidden shadow-sm">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div class="text-sm font-semibold text-gray-900">알림 채팅</div>
                <button id="notiPreviewBtn" type="button" class="text-xs font-semibold text-gray-600 hover:text-gray-900">
                    최근 알림 미리보기
                </button>
            </div>

            <div class="divide-y divide-gray-100">
                <!-- open notification room -->
                <button id="openNotiRoomBtn"
                        type="button"
                        class="w-full text-left px-5 py-4 hover:bg-gray-50 transition">
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <div class="text-sm font-semibold text-gray-900">알림 채팅방 열기</div>
                            <div class="mt-1 text-xs text-gray-500">
                                모든 알림이 채팅처럼 쌓여요. 클릭하면 알림 채팅방으로 이동합니다.
                            </div>
                        </div>
                        <div class="text-xl text-gray-300">›</div>
                    </div>
                </button>

                <!-- recent notifications list -->
                <div class="px-5 py-4">
                    <div class="text-xs font-semibold text-gray-700">최근 알림</div>
                    <div id="notiList" class="mt-3 space-y-2">
                        <div class="text-sm text-gray-500">불러오는 중...</div>
                    </div>
                </div>
            </div>
        </section>

        <div class="text-xs text-gray-400">
            * 경매 채팅은 경매/거래 대화, 알림채팅은 서비스 알림을 채팅 형태로 모아봐요.
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script>
        (() => {
            const tabAuctionBtn = document.getElementById('tabAuction');
            const tabNotiBtn = document.getElementById('tabNoti');
            const notiBadgeEl = document.getElementById('notiBadge');
            const metaEl = document.getElementById('meta');

            const auctionCardEl = document.getElementById('auctionCard');
            const notiCardEl = document.getElementById('notiCard');

            const auctionRoomsEl = document.getElementById('auctionRooms');
            const notiListEl = document.getElementById('notiList');
            const openNotiRoomBtn = document.getElementById('openNotiRoomBtn');
            const notiPreviewBtn = document.getElementById('notiPreviewBtn');

            const TAB_AUCTION = 'AUCTION';
            const TAB_NOTIFICATION = 'NOTIFICATION';

            let activeTab = TAB_AUCTION;

            let auctionLoaded = false;
            let notiLoaded = false;

            let auctionCount = 0;
            let unreadCount = 0;

            function escapeHtml(str) {
                return String(str ?? '')
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#39;');
            }

            function getAccessToken() {
                return localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
            }

            function buildAuthHeaders() {
                const token = getAccessToken();
                if (!token) return {};
                if (token.startsWith('Bearer ')) return { Authorization: token };
                return { Authorization: `Bearer ${token}` };
            }

            function setTabStyles() {
                const isAuction = activeTab === TAB_AUCTION;

                if (isAuction) {
                    tabAuctionBtn.className = 'inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold transition bg-slate-900 text-white';
                    tabNotiBtn.className = 'inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold transition text-gray-700 hover:bg-gray-50';
                } else {
                    tabAuctionBtn.className = 'inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold transition text-gray-700 hover:bg-gray-50';
                    tabNotiBtn.className = 'inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold transition bg-slate-900 text-white';
                }
            }

            function updateMeta() {
                if (activeTab === TAB_AUCTION) {
                    metaEl.textContent = `경매 채팅 ${auctionCount}개`;
                } else {
                    metaEl.textContent = `새 알림 ${unreadCount}개`;
                }
            }

            function showTab(tab) {
                activeTab = tab;

                const isAuction = tab === TAB_AUCTION;
                auctionCardEl.classList.toggle('hidden', !isAuction);
                notiCardEl.classList.toggle('hidden', isAuction);

                setTabStyles();
                updateMeta();

                if (isAuction && !auctionLoaded) {
                    loadAuctionRooms();
                }
                if (!isAuction && !notiLoaded) {
                    loadNotificationPanel();
                }
            }

            function renderAuctionLoading() {
                auctionRoomsEl.innerHTML = `
                  <div class="px-5 py-8 flex items-center gap-3 text-sm text-gray-500">
                    <span class="inline-block h-4 w-4 rounded-full border-2 border-gray-300 border-t-transparent animate-spin"></span>
                    불러오는 중...
                  </div>
                `;
            }

            function renderAuctionEmpty() {
                auctionRoomsEl.innerHTML = `
                  <div class="px-5 py-14 text-center">
                    <div class="mx-auto h-12 w-12 rounded-full bg-gray-100 flex items-center justify-center">
                      <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                      </svg>
                    </div>
                    <div class="mt-4 text-sm font-semibold text-gray-900">아직 채팅방이 없어요</div>
                    <div class="mt-1 text-sm text-gray-500">경매에서 낙찰/거래가 성사되면 채팅이 열려요.</div>
                  </div>
                `;
            }

            function pickRoomId(r) { return r.roomId ?? r.chatRoomId ?? r.id; }
            function pickTitle(r) { return r.auctionTitle ?? r.title ?? r.itemTitle ?? '채팅방'; }
            function pickLast(r) { return r.lastMessage ?? r.lastMessageContent ?? r.lastContent ?? ''; }
            function pickUnread(r) { return r.unreadCount ?? r.unread ?? 0; }
            function pickAt(r) { return r.lastMessageAt ?? r.updatedAt ?? r.lastAt ?? null; }
            function pickType(r) { return r.roomType ?? r.type ?? r.chatRoomType ?? null; }

            function formatTime(v) {
                if (!v) return '';
                const d = new Date(v);
                if (Number.isNaN(d.getTime())) return '';
                const now = new Date();
                const sameDay = d.toDateString() === now.toDateString();
                return sameDay
                    ? d.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                    : d.toLocaleDateString('ko-KR', { month: '2-digit', day: '2-digit' });
            }

            function renderAuctionRooms(rooms) {
                if (!rooms || rooms.length === 0) {
                    renderAuctionEmpty();
                    return;
                }

                rooms.sort((a, b) => {
                    const au = Number(pickUnread(a) || 0);
                    const bu = Number(pickUnread(b) || 0);
                    if (bu !== au) return bu - au;

                    const at = new Date(pickAt(a) ?? 0).getTime();
                    const bt = new Date(pickAt(b) ?? 0).getTime();
                    return bt - at;
                });

                const html = rooms.map(r => {
                    const roomId = pickRoomId(r);
                    const title = escapeHtml(pickTitle(r));
                    const lastRaw = pickLast(r);
                    const last = escapeHtml(lastRaw || '최근 메시지가 없어요.');
                    const unread = Number(pickUnread(r) || 0);
                    const time = formatTime(pickAt(r));

                    return `
                      <a href="/chats/rooms/${encodeURIComponent(roomId)}"
                         class="block px-5 py-4 hover:bg-gray-50 transition">
                        <div class="flex items-start justify-between gap-4">
                          <div class="min-w-0">
                            <div class="flex items-center gap-2">
                              <div class="text-sm font-semibold text-gray-900 truncate">${title}</div>
                              ${unread > 0 ? `
                                <span class="inline-flex items-center rounded-full bg-red-500 px-2 py-0.5 text-[11px] font-bold text-white">
                                  ${unread}
                                </span>` : ``}
                            </div>
                            <div class="mt-1 text-xs text-gray-500 truncate">${last}</div>
                          </div>

                          <div class="flex flex-col items-end gap-1 shrink-0">
                            ${time ? `<div class="text-[11px] text-gray-400 whitespace-nowrap">${time}</div>` : ``}
                            <div class="text-xs text-gray-400">›</div>
                          </div>
                        </div>
                      </a>
                    `;
                }).join('');

                auctionRoomsEl.innerHTML = html;
            }

            async function loadAuctionRooms() {
                renderAuctionLoading();

                try {
                    const headers = buildAuthHeaders();
                    const res = await fetch('/api/chat/rooms', {
                        method: 'GET',
                        headers,
                        credentials: 'same-origin'
                    });

                    if (!res.ok) {
                        const text = await res.text().catch(() => '');
                        auctionRoomsEl.innerHTML = `
                          <div class="px-5 py-8">
                            <div class="rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
                              채팅방 목록을 불러오지 못했어요. (HTTP ${res.status})
                              ${text ? `<div class="mt-2 text-xs text-red-700/90 whitespace-pre-wrap">${escapeHtml(text)}</div>` : ``}
                            </div>
                          </div>
                        `;
                        auctionCount = 0;
                        updateMeta();
                        auctionLoaded = true;
                        return;
                    }

                    const rooms = await res.json();

                    const auctionRooms = Array.isArray(rooms)
                        ? rooms.filter(r => (pickType(r) ? String(pickType(r)) === TAB_AUCTION : true))
                        : [];

                    auctionCount = auctionRooms.length;
                    renderAuctionRooms(auctionRooms);

                    auctionLoaded = true;
                    updateMeta();
                } catch (e) {
                    auctionRoomsEl.innerHTML = `
                      <div class="px-5 py-8">
                        <div class="rounded-xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm text-gray-700">
                          네트워크 오류가 발생했어요.
                        </div>
                      </div>
                    `;
                    auctionCount = 0;
                    auctionLoaded = true;
                    updateMeta();
                }
            }

            function renderNotiLoading() {
                notiListEl.innerHTML = `<div class="text-sm text-gray-500">불러오는 중...</div>`;
            }

            function renderNotiList(list) {
                if (!list || list.length === 0) {
                    notiListEl.innerHTML = `<div class="text-sm text-gray-500">최근 알림이 없어요.</div>`;
                    return;
                }

                const html = list.map(n => {
                    const title = escapeHtml(n.title ?? '');
                    const body = escapeHtml(n.body ?? '');
                    const isUnread = (n.read === false) || (n.isRead === false);
                    const linkUrl = n.linkUrl ?? n.link ?? null;

                    const showLink = linkUrl && linkUrl !== '/';

                    return `
                          <div class="rounded-xl border border-gray-200 bg-white px-4 py-3 hover:bg-gray-50 transition">
                            <div class="flex items-start justify-between gap-3">
                              <div class="min-w-0">
                                <div class="flex items-center gap-2">
                                  <div class="text-sm font-semibold text-gray-900 truncate">${title || '알림'}</div>
                                  ${isUnread ? `<span class="text-[11px] font-extrabold text-red-500">NEW</span>` : ``}
                                </div>
                                <div class="mt-1 text-xs text-gray-600 line-clamp-2">${body}</div>

                                ${showLink ? `
                                  <a href="${escapeHtml(linkUrl)}"
                                     class="mt-2 inline-flex items-center text-xs font-semibold text-slate-700 hover:underline">
                                    바로가기 →
                                  </a>` : ``}
                              </div>
                              <div class="text-xs text-gray-300">›</div>
                            </div>
                          </div>
                        `;
                }).join('');

                notiListEl.innerHTML = html;
            }

            async function loadUnreadCount() {
                try {
                    const headers = buildAuthHeaders();
                    const res = await fetch('/api/notifications/unread-count', {
                        method: 'GET',
                        headers,
                        credentials: 'same-origin'
                    });

                    if (!res.ok) {
                        unreadCount = 0;
                        notiBadgeEl.classList.add('hidden');
                        return 0;
                    }

                    const value = await res.json();
                    const n = Number(value || 0);
                    unreadCount = n;

                    if (n > 0) {
                        notiBadgeEl.textContent = String(n);
                        notiBadgeEl.classList.remove('hidden');
                    } else {
                        notiBadgeEl.classList.add('hidden');
                    }

                    updateMeta();
                    return n;
                } catch (e) {
                    unreadCount = 0;
                    notiBadgeEl.classList.add('hidden');
                    updateMeta();
                    return 0;
                }
            }

            async function loadNotificationPanel() {
                renderNotiLoading();

                await loadUnreadCount();

                try {
                    const headers = buildAuthHeaders();
                    const res = await fetch('/api/notifications?page=0&size=10', {
                        method: 'GET',
                        headers,
                        credentials: 'same-origin'
                    });

                    if (!res.ok) {
                        renderNotiList([]);
                        notiLoaded = true;
                        return;
                    }

                    const data = await res.json();
                    const list = Array.isArray(data) ? data : (Array.isArray(data.content) ? data.content : []);
                    renderNotiList(list);

                    notiLoaded = true;
                    updateMeta();
                } catch (e) {
                    renderNotiList([]);
                    notiLoaded = true;
                    updateMeta();
                }
            }

            async function openNotificationRoom() {
                try {
                    const headers = buildAuthHeaders();
                    const res = await fetch('/api/chat/notification-room', {
                        method: 'GET',
                        headers,
                        credentials: 'same-origin'
                    });

                    if (!res.ok) {
                        const text = await res.text().catch(() => '');
                        alert(`알림 채팅방을 열 수 없어요. (HTTP ${res.status})\n${text}`);
                        return;
                    }

                    const roomId = await res.json();
                    location.href = `/chats/rooms/${encodeURIComponent(roomId)}?type=NOTIFICATION`;
                } catch (e) {
                    alert('네트워크 오류가 발생했어요.');
                }
            }

            tabAuctionBtn.addEventListener('click', () => showTab(TAB_AUCTION));
            tabNotiBtn.addEventListener('click', () => showTab(TAB_NOTIFICATION));

            openNotiRoomBtn.addEventListener('click', openNotificationRoom);
            notiPreviewBtn.addEventListener('click', () => {
                notiLoaded = false;
                loadNotificationPanel();
            });

            // 초기 진입: 기본 경매 탭
            setTabStyles();
            updateMeta();
            loadAuctionRooms();

            // 알림 배지/카운트는 미리 한 번 불러두면 UX 좋음
            loadUnreadCount();
        })();
    </script>
</th:block>
</body>
</html>
